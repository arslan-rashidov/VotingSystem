<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/VotingSystem.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> VotingSystem.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>58/58</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>32/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>13/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>58/58</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.8.0;
// SPDX-License-Identifier: UNLICENSED
&nbsp;
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Timers.sol";
import "@openzeppelin/contracts/utils/Counters.sol";
import "./IVotingSystem.sol";
&nbsp;
contract VotingSystem is IVotingSystem, Ownable {
    using Timers for Timers.Timestamp;
    using Counters for Counters.Counter;
&nbsp;
    event VotingCreated(address[] candidates, uint256 votingID);
    event VoteMade(uint256 votingID, address votedCandidate, address voter); 
    event VotingFinished(uint256 votingID, address winner);
    event GotVotingStatus(uint256 votingID, bool isActive);
    event GotVotingCandidates(uint256 votingID, address[] candidates);
    event GotCandidateVotes(uint256 votingID, address candidate, uint256 votes);
    event CreatorFeeWithdrawed(bool isSent, uint256 amount);
&nbsp;
    struct Voting {
        VotingStatus status;
        address[] candidatesArray;
        mapping (address =&gt; bool) candidates;
        mapping (address =&gt; bool) voters;
&nbsp;
        uint256 maximumCandidateVotes;
        address bestCandidate;
        mapping (address =&gt; uint256) votes;
&nbsp;
        Timers.Timestamp votingEnd;
        uint256 earnedEthereumAmount;
    }
&nbsp;
    mapping (uint256 =&gt; Voting) private _votings;
    Counters.Counter private _votingIDCounter;
    uint256 private _creatorFee;
&nbsp;
    function createVoting(address[] memory candidates_) external onlyOwner override {
        _votingIDCounter.increment();
        
        Voting storage voting = _votings[_votingIDCounter.current()];
&nbsp;
        for (uint256 i = 0; i &lt; candidates_.length; i++) {
            voting.candidates[candidates_[i]] = true;
        }
        voting.votingEnd.setDeadline(uint64(block.timestamp + 3 days));
&nbsp;
        voting.candidatesArray = candidates_;
        voting.maximumCandidateVotes = 0;
&nbsp;
        emit VotingCreated(candidates_, _votingIDCounter.current());
    }
&nbsp;
    function makeVote(uint256 votingID, address votedCandidate) external payable override {
        require(_isVotingExists(votingID), "Voting does not exist."); //
        require(msg.value == 0.01 ether, "You need to send 0.01 Ether to make a vote.");//
&nbsp;
        Voting storage voting = _votings[votingID];
&nbsp;
        require(_isVotingActive(voting), "Voting has already finished."); //
&nbsp;
        address voter = msg.sender;
&nbsp;
        require(!_isVoterVoted(voting, voter), "You already voted in this voting."); //
        require(_isVotingCandidateExists(voting, votedCandidate), "There is no such candidate."); //
&nbsp;
        voting.votes[votedCandidate] += 1;
&nbsp;
&nbsp;
&nbsp;
        if (voting.votes[votedCandidate] &gt; voting.maximumCandidateVotes) {
            voting.maximumCandidateVotes = voting.votes[votedCandidate];
            if (voting.bestCandidate != votedCandidate) {
                voting.bestCandidate = votedCandidate;
            }
        }
&nbsp;
        voting.voters[voter] = true;
        voting.earnedEthereumAmount += msg.value;
&nbsp;
        emit VoteMade(votingID, votedCandidate, voter);
    }
&nbsp;
    function finishVoting(uint256 votingID) external override {
        require(_isVotingExists(votingID), "Voting does not exist."); 
&nbsp;
        Voting storage voting = _votings[votingID];
&nbsp;
        require(_isVotingActive(voting), "Voting has already finished."); 
        require(_isVotingExpired(voting), "Voting is still going.");
&nbsp;
        voting.status = VotingStatus.Finished;
&nbsp;
        address winner = voting.bestCandidate;
        uint256 reward = voting.earnedEthereumAmount * 9 / 10;
        uint256 fee = voting.earnedEthereumAmount - reward;
        _creatorFee += fee;
&nbsp;
        payable(winner).transfer(reward);
&nbsp;
        emit VotingFinished(votingID, winner);
    }
&nbsp;
    function getVotingStatus(uint256 votingID) external override {
        require(_isVotingExists(votingID), "Voting does not exist."); 
        Voting storage voting = _votings[votingID];
        VotingStatus status_ = voting.status;
&nbsp;
        if (status_ == VotingStatus.Active) {
            emit GotVotingStatus(votingID, true);
        } else {
            emit GotVotingStatus(votingID, false); 
        }
    }
&nbsp;
    function getVotingCandidates(uint256 votingID) external override {
        require(_isVotingExists(votingID), "Voting does not exist.");
        Voting storage voting = _votings[votingID];
&nbsp;
        emit GotVotingCandidates(votingID, voting.candidatesArray);
    }
&nbsp;
    function getCandidateVotes(uint256 votingID, address candidate) external override {
        require(_isVotingExists(votingID), "Voting does not exist.");
        Voting storage voting = _votings[votingID];
        require(_isVotingCandidateExists(voting, candidate), "Candidate does not exist.");
&nbsp;
        emit GotCandidateVotes(votingID, candidate, voting.votes[candidate]);
    }
&nbsp;
    function withdrawCreatorFee() external onlyOwner override {
        require(!_isCreatorFeeEmpty(), "Nothing to withdraw.");
&nbsp;
        payable(msg.sender).transfer(_creatorFee);
&nbsp;
        emit CreatorFeeWithdrawed(true, _creatorFee);
&nbsp;
        _creatorFee = 0;
    }
&nbsp;
    function _isVotingExists(uint256 votingID) private view returns (bool) {
        Voting storage voting = _votings[votingID];
        return voting.votingEnd.isUnset() == false;
    }
&nbsp;
    function _isVotingActive(Voting storage voting) private view returns (bool) {
        return voting.status == VotingStatus.Active;
    }
&nbsp;
    function _isVotingExpired(Voting storage voting) private view returns (bool) {
        return voting.votingEnd.isExpired();
    }
&nbsp;
    function _isVoterVoted(Voting storage voting, address voter) private view returns (bool) {
        return voting.voters[voter];
    }
&nbsp;
    function _isVotingCandidateExists(Voting storage voting, address candidate) private view returns (bool) {
        return voting.candidates[candidate];
    }
&nbsp;
    function _isCreatorFeeEmpty() private view returns (bool) {
        return !(_creatorFee &gt; 0);
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Jun 25 2022 23:29:01 GMT+0300 (Москва, стандартное время)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
